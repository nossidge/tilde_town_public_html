<!DOCTYPE HTML>
<html>

<head>
<meta charset='utf-8' content='utf-8' http-equiv='encoding'>
<script src='../lib/Chart.bundle.min.js'></script>

<style type='text/css'>
  #content {
    width: 700px;
    margin:0 auto;
  }
  p                 { text-align: center; }
  table             { margin: 0 auto; }
  tr td:first-child { padding-left: 0px; }
  tr td:last-child  { text-align: right; }
  td                { padding: 0px 0px 0px 12px; }
</style>

<script>
window.addEventListener('load', function() {

  // Grab data from the JSON file.
  var x = new XMLHttpRequest();
  x.open('GET', 'users.json', true);
  x.responseType = 'json';
  x.onload = function() {
    var objJSON = x.response;

    // Need to be kind of randomised, but the same colour each load.
    // So use sine to approximate this randomness.
    // Colour will be the same per "seed" number.
    var randomSinColour = function (seed) {
      var x = Math.sin(seed) * 10000;
      var sinRand = x - Math.floor(x);
      return '#' + (sinRand.toString(16) + '0000000').slice(2, 8);
    };

    // Extract JSON data to just "URL" : "User Count"
    var hashJSON = {};
    for (var tildeSite in objJSON) {
      var userCount = 0;
      for (var tildeUser in objJSON[tildeSite]) {
        userCount++;
      }
      if (userCount != 0) {
        hashJSON[tildeSite] = userCount;
      }
    }
    
    // Sort the hash by the user count.
    sortedArray = [];
    for (var key in hashJSON) {
      sortedArray.push([key, hashJSON[key]]);
    }
    sortedArray.sort(function(a, b) {return a[1] - b[1]});
    
    // Loop through the sorted array, backwards.
    // But the colours need to go forwards.
    var labels = [], colour = [], data = [];
    var j = 1;
    for (var i = sortedArray.length - 1 ; i >= 0; i--) {
      j++;
      labels.push( sortedArray[i][0] );
      data.push( sortedArray[i][1] );
      colour.push( randomSinColour(j) );
    };
    
    // The chart options, including the legend HTML.
    var config = {
      type: 'pie',
      data: {
        datasets: [{
          data: data,
          backgroundColor: colour,
        }],
        labels: labels
      },
      options: {
        responsive: true,
        animation: false,
        legend: {
          display: true,
          position: 'bottom',
        },
        legendCallback: function(){
          html = '<table>';
          for (var i=0; i<data.length; i++) {
            html += '<tr>';
            html += '<td style="background-color:' + colour[i] + ';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>'
            html += '<td><a href=' + labels[i] + '>' + labels[i] + '</a></td>'
            html += '<td>' + data[i] + '</td>'
            html += '</tr>'
          }
          html += '</table>';
          return html;
        }
      }
    };
    
    // Create the chart.
    var ctx = document.getElementById('tildePie').getContext('2d');
    tildePie = new Chart(ctx, config);
    
    // Generate the legend, and put it in the 'legend' element.
    var legend = tildePie.generateLegend();
    document.getElementById('legend').innerHTML = legend;
  }
  
  x.send(null);
});
</script>
</head>

<body>
  <div id='content'>
    <p><big>Tildeverse <a href='users.html'>user</a> count by <a href='boxes.html'>box</a>.</big></p>
    <p>Source data from the Tildeverse <a href='users.html'>user list</a>.</p>
    <hr>
    <div id='legend' style='margin: 0 auto; padding: 120;'></div>
    <br>
    <canvas id='tildePie' width='400px' height='400px' style='float: right;'></canvas>
  </div>
</body>
</html>
